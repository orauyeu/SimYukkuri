# 開発の流れについての簡単な説明

* **この手順は未完成です!**
* **随時更新される可能性があります!**
* **GitおよびGitHubは非常に多機能であり、Web上に多くの解説記事があります。この文書で説明したやり方は1例に過ぎません。もっと効率的で便利な方法もあります。ぜひ検索してみてください。**

Git (またはGitHub) を使うと「**失敗しても簡単にやり直せる**」ようになるので、気軽に新機能を追加できます。ちょっと操作は複雑ですが、その分、とても役立ちます。

開発は、いわゆる「_GitHub flow_」っぽい流れに基づくと失敗を怖がらずにすむようになるでしょう。

## 開発の前に

### 開発環境の準備
開発に参加するには、開発用のマシンと次のようなソフトウェアが必要になります。

* [Git](https://git-scm.com/download)
* [Java Development Kit (JDK)](http://www.oracle.com/technetwork/java/javase/downloads/)
* コンテンツ編集用ソフトウェア。作成するコンテンツに応じて用意します。
	* コードエディタ (UTF-8およびLFのみの改行コードが扱えるもの)。例えば
		* [Atom](https://atom.io/)
		* [Visual Studio Code](https://code.visualstudio.com/)
	* IDE (統合開発環境)。例えば
		* [IntelliJ IDEA](https://www.jetbrains.com/idea/)
		* [Eclipse](https://www.eclipse.org/)
	* 画像編集ソフトウェア。
* (必要であれば ) Gitクライアント
	* Gitリポジトリを視覚化し、扱いやすくします。Gitに慣れていない人にはおすすめです。それぞれのプラットフォームで色々ありますのでお好みのものを。
	* 詳しくは公式サイトで提供されている[GUI Clients](https://git-scm.com/downloads/guis)の一覧が役に立ちます。
	* IDEなどでは、最初からクライアントが統合されていることもあります。

#### インストール
ほとんどの場合、上記のソフトウェアは公式Webサイトからダウンロードしたファイルをデフォルトの設定でインストールすれば問題ありません。しかしプラットフォームによっては特別な手順が必要になる場合があります。

インストールの順番については、リストの上の方から順番にやっていくとトラブルが少なくなるでしょう。
これは、IntlliJ IDEAやEclipseなどのJava製アプリケーションは、JDK (または最低でもJRE) のインストールが必要になるからです。

##### Windows
基本的に公式パッケージをダウンロードしてインストーラに従えば問題ありません。

ただしWindows用のGitは非常にインストールオプションが多く、どのオプションを有効にすればよいか迷うかもしれません。基本的にはデフォルトのままで十分安全ですが、「`git windows インストール`」ぐらいのキーワードで検索すると参考になるでしょう。

注意点として、「Select Components」の画面では選択できるオプション「Use a TrueType fot in all conole windows」は絶対にデフォルトのままoffにしておいてください。onにすると文字化けするようになってしまいます。

##### macOS
基本的に公式パッケージをダウンロードしてインストーラに従えば問題ありません。

Gitに関してはHomebrewでもインストールできます。もし既にHomebrewを使ってパッケージ管理を行っている場合、Homebrewを使うほうが簡単かもしれません。

##### Linux
Linux系OSについては、各ディストリビューションのパッケージリポジトリからマネージャ (`apt`、`yum`、`pacman`、`portage`など) を使ったインストールをおすすめします。

パッケージリポジトリでソフトウェアが提供されていない場合に限り、公式パッケージを使ってみてください。

その場合、コードエディタやIDEなどの大規模なソフトウェアについては`.deb`や`.rpm`でパッケージングされていることがほとんどです。それらのパッケージを扱えるディストリビューション以外では使いにくいかもしれません。

もし`.tar.gz`で提供されている場合、`/opt`あたりに専用ディレクトリを掘ってアーカイブを展開すればだいたい動きます。

ソースだけで提供されている場合は、大抵ドキュメンテーションにやり方が書いてあると思うのですが……環境によっては非常に残念な結果になることも多いので、何とかうまくいくことを祈ります。

### GitHubアカウントの用意

GitHubは、共同作業を行いやすくするためのWebサービスです。

1. メールアドレスを用意してください。
	* 匿名性を確保したいなら、専用メールアドレスの取得をお勧めします。
2. GitHubアカウントを作成してください。
	* メールアドレスとパスワードが必要です。無料 (free) プランで問題ありません。
3. GitHubにサインインしたら、初期設定を行ってください。
	1. 右上のアイコンより「Settings」を選んでください。
	2. 左のメニューから「Emails」を選び、「Keep my email address private」および「Block command line pushes that expose my email」をチェックしてください。
	3. 「Keep my email address private」説明文の中に**太字**で記載されているメールアドレス ("_hogehoge_@users.noreply.github.com"形式のもの) をコピーしてください。

コピーしたアドレスは、Gitの変更ログ (ログにはメールアドレスが記録されます) に使用するべき**ダミーアドレス**であり、メールアドレスを不用意に公開しない様にするためのものです。

コピーしたダミーアドレスはこの後、リポジトリの設定で使用します。

### リポジトリの準備

**リポジトリ**とは、プロジェクトのソース一式が格納された作業スペースのことです。開発を始めるには、最初にリポジトリの準備をする必要があります。

例はローカルマシンのコマンドラインで作業することを想定しています。

1. GitHubにサインインしてください。
2. SimYukkuriのプロジェクトページにアクセスしてください。
3. ページ右上の「Fork」を押し、プロジェクトをフォーク (分岐) してください。フォークすると、元プロジェクトをコピーした自分専用の作業スペース (リポジトリ) がGitHub上に作成されます。開発作業は、フォークしたリポジトリ内で行っていくことになります。
4. ローカル開発環境にフォークしたリポジトリをクローン (複製) します。実際の作業はローカルマシンで行うので、このコピー作業が必要になります。

	リポジトリを保存したいディレクトリのパスを`$WORKSPACE`、自分のGitHub上でのIDを`$id`とすると

			cd $WORKSPACE
			git clone https://github.com/$id/SimYukkuri.git
	これで、`$WORKSPACE/SimYukkuri`にリポジトリが複製されます。

5. クローン後、リポジトリを設定します。コピーしたダミーアドレスは、ここで使用します。

		cd $WORKSPACE/SimYukkuri
		git config --local user.name "名前"
		git config --local user.email "ダミーアドレス"
この作業によって、Gitの変更ログに記録される**名前**と**メールアドレス**を設定するものです。この設定を行わない場合、不用意にユーザ名やメールアドレスが流出するかもしれません。

6. フォーク元リポジトリ (本家) へ簡単にアクセスできるように設定します。これは、本家が更新されたら、フォーク先リポジトリ (分家) も更新に追随できるようにするためです。

		git remote add upstream https://github.com/orauyeu/SimYukkuri.git
これで、`upstream`という名前で本家にアクセスできるようになりました。

## 開発作業の手順

### 開発

開発は、GitHub flowっぽい手順で行っていきます。

新しい機能やリソース (フィーチャとかトピックとか言います) を追加する場合、以下のような方法で専用のブランチを作って作業を行ってください。何かミスってもさっくりブランチを消せば元通り。

逆に言うと、メインの`master`ブランチはクリーンな (いつでも不具合なく動作する) 状態であるようにしておく必要があります。そうすれば、いつでもちゃんと動作したあの頃に戻せます。

以下はローカルマシン上のコマンドラインでの作業の例です。

1. 追加する機能やリソース専用の新しいブランチ (トピックブランチ) を作成します。ブランチ名 (例では "_new-great-feature_") は名は体を表す感じで適当に付けてください。

		git branch "new-great-feature"
		git checkout "new-great-feature"

2. ファイルを更新したり色々作業してください。作業は、コンテンツの種類によって異なります。
3. リポジトリに管理対象に追加します。例えば

		git add .
	としますが、実はやり方が色々あるので調べてみてください。
4. リポジトリに変更をコミット (登録) します。コミットの粒度は細かいほうがいいかもしれません。失敗してもすぐにもとに戻せるので。

		git commit -m "コミット内容の説明"
	「コミット内容の説明」は、短く分かりやすい内容でお願いします。
5.  新しいフィーチャを含んだプロダクトが不具合なく動作する状態になるまで、2～4を繰り返します。
6. 変更を含むトピックブランチをGitHubに送信します。

		git push origin "new-great-feature"
	これで、GitHub上でも変更が確認できるはずです。分家リポジトリのプロジェクトページをご覧ください。


**TODO** : 失敗した時の各種巻き戻し方法

### 追加した機能の統合

**TODO** : PR用のブランチはrebaseしてsquashするとかはルールにする? それともGitHub上でSquash mergingする?

いい感じの機能やコンテンツができたら、本家リポジトリに追加機能のマージ (統合) をリクエストしましょう。

1. GitHubの分家プロジェクトページ上でプルリクエスト (Pull Request、PR) を作成します。
	1. トピックブランチをアクティブにします。
	2. 「Compare & pull request」を押します。
	3. マージしたい機能について、タイトルと説明を記述し、「Create pull request」を押してPRを作成します。
2. マージ担当者が内容の評価を行います。理由がある場合、PRが拒否されることも有ります。
	* 受け入れられた場合: マージ担当者が内容をマージします。次回のリリースにご期待ください。
	* 拒否された場合 : 何らかの理由でマージできない状態です。マージ担当者がコメントを残しているはずなので、[開発](#開発)の手順2～6を繰り返し、トピックブランチを修正し、pushしてみてください。トピックブランチの修正とpushは、自動的にPRに反映されます。

### 後始末

ローカルマシン上での作業です。

1. マージが完了したら、作成したトピックブランチは不要になります。お掃除しましょう。

		git checkout master
		git branch -D "new-great-feature"
2. リモート (GitHub) 上に送信した分家リポジトリのトピックブランチも不要になります。始末しましょう。

		git push origin :"new-great-feature"
3. 本家リポジトリが更新されているはずなので、分家リポジトリにその更新を取り込みます。下記の手順を参照してください。

### 本家リポジトリの更新に追随する

本家リポジトリが更新された場合、その変更に追随するべきです。

本家リポジトリ → ローカルマシン上のリポジトリ → 分家リポジトリの順番で更新していきます。

**注意** : 更新前、既にトピックブランチで作業中の場合、stashしてrebaseしたほうがいいでしょう。

**TODO** : rebaseの手順を書く

1. ローカルのリポジトリを更新します。

		git checkout master
		git pull upstream master
	これで`upstream`として参照される本家リポジトリの`master`ブランチでローカルの`master`ブランチを更新できました。

2. GitHub上の分家リポジトリを更新します。

		git push

このあと、[開発](#開発)から作業を繰り返します。

## Collaborator向けの手順

上記の手順は、"Collaborator"ではない開発者向けです。Collaboratorは本家リポジトリに直接pushできるので、本家リポジトリの更新に追随する必要がありません。

その他の手順は、上記のようにトピックブランチを使用した「GitHub flow」スタイルでPRを作成する方法で。

またPRがある場合、Collaboratorの誰かがレビューをしてください。レビュアは内容を確認し、ビルドできるかをチェックした上でマージしてください。コンフリクトがある場合は解決してください。

**TODO** : squash mergingする?

## Collaboratorになるには

**TODO** : どういうやり方にしよう?
